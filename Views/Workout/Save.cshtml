@model WorkoutViewModel

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>@Model.Description - Workout</title>
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
        .rectangle-border {
            border: 2px solid black;
            padding: 20px;
            margin: 20px;
        }

        .sortable-item {
            cursor: move;
        }

        .sortable-superset-exercises {
            margin-top: 10px;
            border-top: 2px dashed #ccc;
            padding-top: 10px;
            min-height: 50px;
            background-color: #f9f9f9;
            position: relative;
        }

            .sortable-superset-exercises.empty:before {
                content: "Перетащите упражнение сюда";
                color: #888;
                font-size: 14px;
                text-align: center;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                pointer-events: none;
            }
    </style>
</head>
<body>
    <h1>@Model.Description</h1>

    <form method="post" action="@Url.Action("SaveOrder", "Workout")">
        <input type="hidden" name="Id" value="@Model.Id" />
        <input type="hidden" name="Description" value="@Model.Description" />
        <label>
            <input type="checkbox" name="IsPublic" value="true" @(Model.IsPublic ? "checked" : "") /> Public Workout
        </label>
        <div id="sortable">
            @if (Model.WorkoutItems != null)
            {
                @foreach (var item in Model.WorkoutItems)
                {
                    if (item is WorkoutExercise workoutExercise && workoutExercise.Exercise != null)
                    {
                        var exercise = workoutExercise.Exercise;
                        <div class="sortable-item rectangle-border" data-id="@exercise.Id" data-type="exercise">
                            <input type="hidden" name="WorkoutExercises[@exercise.Id].Id" value="@exercise.Id" />
                            <input type="hidden" name="WorkoutExercises[@exercise.Id].Position" value="0" />
                            <h3><a asp-action="Details" asp-controller="Exercises" asp-route-id="@exercise.Id">@exercise.Name</a></h3>
                            <p>@exercise.Description</p>
                            <a asp-controller="Account" asp-action="Profile" asp-route-id="@exercise.AuthorId">@exercise.User?.Name</a>
                        </div>
                    }
                    else if (item is Superset superset && superset.WorkoutExercises != null)
                    {
                        <div class="sortable-superset rectangle-border" data-id="@superset.Id" data-type="superset">
                            <input type="hidden" name="Supersets[@superset.Id].Id" value="@superset.Id" />
                            <input type="hidden" name="Supersets[@superset.Id].Position" value="0" />
                            <strong>Superset</strong>
                            <div class="sortable-superset-exercises">
                                @foreach (var workoutExerciseItem in superset.WorkoutExercises)
                                {
                                    var exercise = workoutExerciseItem?.Exercise;
                                    if (exercise != null)
                                    {
                                        <div class="sortable-item rectangle-border" data-id="@exercise.Id" data-type="exercise">
                                            <input type="hidden" name="Supersets[@superset.Id].Exercises[@exercise.Id].Id" value="@exercise.Id" />
                                            <input type="hidden" name="Supersets[@superset.Id].Exercises[@exercise.Id].Position" value="0" />
                                            <h3><a asp-action="Details" asp-controller="Exercises" asp-route-id="@exercise.Id">@exercise.Name</a></h3>
                                            <p>@exercise.Description</p>
                                            <a asp-controller="Account" asp-action="Profile" asp-route-id="@exercise.AuthorId">@exercise.User?.Name</a>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                }
            }
        </div>

        <button type="submit">Save Order</button>
    </form>

    <br />
    <a asp-controller="Exercises" asp-action="Index">Add Exercise to Workout</a>
    <br />
    <form asp-controller="Workout" asp-action="AddSuperset" method="post">
        <input type="hidden" name="workoutId" value="@Model.Id" />
        <button type="submit">Add Superset</button>
    </form>
    <br />
    <a asp-action="UserWorkouts" asp-route-id="@Model.Id">Back to Workout</a>

    <script>
        $(function () {
            function updateSupersetEmptyState() {
                $(".sortable-superset-exercises").each(function () {
                    if ($(this).children().length === 0) {
                        $(this).addClass("empty");
                    } else {
                        $(this).removeClass("empty");
                    }
                });
            }

            $("#sortable").sortable({
                items: "> .sortable-item, > .sortable-superset",
                connectWith: ".sortable-superset-exercises",
                placeholder: "ui-state-highlight",
                update: function () {
                    updatePositions();
                }
            });

            $(".sortable-superset-exercises").sortable({
                connectWith: "#sortable, .sortable-superset-exercises",
                placeholder: "ui-state-highlight",
                update: function () {
                    updatePositions();
                }
            });

            $("#sortable, .sortable-superset-exercises").disableSelection();

            updateSupersetEmptyState();

            function updatePositions() {
                var position = 1;

                $('#sortable > .sortable-item').each(function () {
                    if ($(this).data('type') === 'exercise') {
                        var positionInput = $(this).find('input[name$="Position"]');
                        positionInput.val(position++);
                        console.log("Exercise Position:", positionInput.val());
                    }
                });

                $('.sortable-superset').each(function () {
                    var supersetId = $(this).data('id');
                    $(this).find('.sortable-superset-exercises > .sortable-item').each(function (index) {
                        var positionInput = $(this).find('input[name$="Position"]');
                        positionInput.val(index + 1);
                        console.log("Superset Exercise Position:", positionInput.val());
                    });
                });
            }
        });
    </script>
</body>
</html>
