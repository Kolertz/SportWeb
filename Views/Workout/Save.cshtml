@model WorkoutViewModel

<!-- Основная форма для сохранения порядка -->
<form id="saveOrderForm" asp-action="SaveOrder" asp-controller="Workout" method="post">
    <input type="hidden" name="workoutId" value="@Model.Id" />

    <div id="workout-container" class="workout-container">
        @for (int i = 0; i < Model.WorkoutItems.Count; i++)
        {
            var item = Model.WorkoutItems.ElementAt(i);
            if (item is WorkoutExercise exerciseItem && exerciseItem.SupersetId == null)
            {
                var exercise = exerciseItem.Exercise;
                <div class="sortable-item rectangle-border" data-id="@exercise.Id" data-type="exercise">
                    <input type="hidden" name="WorkoutPositions[@i].Id" value="@exerciseItem.ExerciseId" form="saveOrderForm" />
                    <input type="hidden" name="WorkoutPositions[@i].Position" value="@exerciseItem.Position" class="position-input" form="saveOrderForm" />
                    <input type="hidden" name="WorkoutPositions[@i].IsSuperset" value="false" form="saveOrderForm" />
                    <input type="hidden" name="WorkoutPositions[@i].SupersetId" value="" form="saveOrderForm" />

                    <h3><a asp-action="Details" asp-controller="Exercises" asp-route-id="@exercise.Id">@exercise.Name</a></h3>
                    <p>@exercise.Description</p>
                    <a asp-controller="Account" asp-action="Profile" asp-route-id="@exercise.AuthorId">@exercise.User?.Name</a>

                    <!-- Кнопка для удаления упражнения, привязанная к своей форме -->
                    <br />
                    <button type="submit" form="removeExerciseForm-@exercise.Id" class="btn btn-danger">Remove Exercise</button>
                </div>
            }
            else if (item is Superset superset)
            {
                <div class="sortable-superset rectangle-border" data-id="@superset.Id" data-type="superset">
                    <input type="hidden" name="WorkoutPositions[@i].Id" value="@superset.Id" form="saveOrderForm" />
                    <input type="hidden" name="WorkoutPositions[@i].Position" value="@superset.Position" class="position-input" form="saveOrderForm" />
                    <input type="hidden" name="WorkoutPositions[@i].IsSuperset" value="true" form="saveOrderForm" />
                    <input type="hidden" name="WorkoutPositions[@i].SupersetId" value="0" form="saveOrderForm" />

                    <strong>Superset @superset.Id</strong>

                    <div class="sortable-superset-exercises @(superset.WorkoutExercises.Count == 0 ? "empty" : "")">
                        @for (int j = 0; j < superset.WorkoutExercises.Count; j++)
                        {
                            var exerciseItemInSuperset = superset.WorkoutExercises.ElementAt(j);
                            var exerciseInSuperset = exerciseItemInSuperset.Exercise;
                            <div class="sortable-item rectangle-border" data-id="@exerciseInSuperset.Id" data-type="exercise">
                                <input type="hidden" name="WorkoutPositions[@i + @j + 1].Id" value="@exerciseItemInSuperset.ExerciseId" form="saveOrderForm" />
                                <input type="hidden" name="WorkoutPositions[@i + @j + 1].Position" value="@exerciseItemInSuperset.Position" class="position-input" form="saveOrderForm" />
                                <input type="hidden" name="WorkoutPositions[@i + @j + 1].IsSuperset" value="false" form="saveOrderForm" />
                                <input type="hidden" name="WorkoutPositions[@i + @j + 1].SupersetId" value="@superset.Id" form="saveOrderForm" />

                                <h3><a asp-action="Details" asp-controller="Exercises" asp-route-id="@exerciseInSuperset.Id">@exerciseInSuperset.Name</a></h3>
                                <p>@exerciseInSuperset.Description</p>
                                <br />
                                <!-- Кнопка для удаления упражнения, привязанная к своей форме -->
                                <button type="submit" form="removeExerciseForm-@exerciseInSuperset.Id" class="btn btn-danger">Remove Exercise</button>
                            </div>
                        }
                    </div>

                    <!-- Кнопка для удаления суперсета, привязанная к своей форме -->
                    <button type="submit" form="removeSupersetForm-@superset.Id" class="btn btn-danger">Remove Superset</button>
                </div>
            }
        }
    </div>

    <!-- Кнопка для сохранения порядка -->
    <button type="submit" id="save-order-btn" class="btn btn-success">Save Order</button>
</form>

<!-- Формы для удаления упражнений -->
@foreach (var item in Model.WorkoutItems.OfType<WorkoutExercise>())
{
    <form id="removeExerciseForm-@item.ExerciseId" asp-action="RemoveExercise" asp-controller="Workout" method="post">
        <input type="hidden" name="workoutId" value="@Model.Id" />
        <input type="hidden" name="exerciseId" value="@item.ExerciseId" />
    </form>
}

<!-- Формы для удаления суперсетов -->
@foreach (var superset in Model.WorkoutItems.OfType<Superset>())
{
    <form id="removeSupersetForm-@superset.Id" asp-action="RemoveSuperset" asp-controller="Workout" method="post">
        <input type="hidden" name="workoutId" value="@Model.Id" />
        <input type="hidden" name="supersetId" value="@superset.Id" />
    </form>
}
<br />
<form asp-action="Index" asp-controller="Exercises">
    <input type="hidden" name="workoutId" value="@Model.Id" />
    <button type="submit" class="btn btn-primary">Add Exercise</button>
</form>

<form asp-action="AddSuperset" asp-controller="Workout" method="post" style="display:inline;">
    <input type="hidden" name="workoutId" value="@Model.Id" />
    <button type="submit" class="btn btn-primary">Add Superset</button>
</form>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var workoutContainer = document.getElementById('workout-container');

            // Initialize Sortable.js for drag & drop
            new Sortable(workoutContainer, {
                animation: 150,
                group: {
                    name: 'shared',
                    pull: true,
                    put: true
                },
                onEnd: function (evt) {
                    updatePositions();
                }
            });

            // Enable nested sorting within supersets
            document.querySelectorAll('.sortable-superset-exercises').forEach(function (element) {
                new Sortable(element, {
                    group: 'shared',
                    animation: 150,
                    onEnd: function (evt) {
                        updatePositions();
                    }
                });
            });

            // Update positions after sorting
            function updatePositions() {
                var items = workoutContainer.querySelectorAll('.sortable-item, .sortable-superset');
                var globalPosition = 0; // Общая позиция для всех элементов
                var supersetPositions = {}; // Отслеживание позиций внутри каждого суперсета

                items.forEach(function (item, index) {
                    var positionInput = item.querySelector('.position-input');
                    var isInSupersetInput = item.querySelector('input[name$=".SupersetId"]');
                    var isSuperset = item.dataset.type === 'superset';

                    if (isSuperset) {
                        // Если это суперсет, то устанавливаем глобальную позицию для него
                        positionInput.value = globalPosition++;
                    } else {
                        var supersetId = isInSupersetInput.value;

                        if (supersetId && supersetId != "0") {
                            // Если элемент внутри суперсета
                            if (!supersetPositions[supersetId]) {
                                supersetPositions[supersetId] = 0;
                            }
                            positionInput.value = supersetPositions[supersetId]++;
                        } else {
                            // Если элемент не внутри суперсета, то устанавливаем глобальную позицию
                            positionInput.value = globalPosition++;
                        }
                    }
                });
            }

        });
    </script>
}
